{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard | StockPilot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h2 class="h4 fw-bold">Dashboard</h2>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="row g-4">

    <div class="col-md-3 col-sm-6">
      <div class="card card-custom p-3 text-center">
        <h6 class="text-muted">Total Products</h6>
        <h3 class="fw-bold">{{ total_products }}</h3>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card card-custom p-3 text-center">
        <h6 class="text-muted">Total Sales</h6>
        <h3 class="fw-bold">${{ total_sales }}</h3>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card card-custom p-3 text-center">
        <h6 class="text-muted">Current Stock</h6>
        <h3 class="fw-bold">{{ current_stock }}</h3>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card card-custom p-3 text-center">
        <h6 class="text-muted">Low Stock</h6>
        <h3 class="fw-bold">{{ low_stock }}</h3>
      </div>
    </div>

 
    <div class="col-lg-8">
      <div class="card card-custom p-3">
        <h5 class="fw-bold">Weekly Sales</h5>
        <small class="text-muted">Last 7 Days</small>
        <canvas id="salesChart" height="500" class="mt-3"></canvas>
      </div>
    </div>


<div class="col-lg-4">
  <div class="card p-3 recent-activity">
    <h5 class="fw-bold mb-3">Recent Activities</h5>
    <ul class="list-unstyled mb-0">


      {% for sale in recent_sales %}
      <li class="d-flex align-items-center mb-3">
        <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle d-flex align-items-center justify-content-center">
          <span class="material-symbols-outlined">receipt_long</span>
        </div>
        <div class="ms-2">
          <p class="mb-0 fw-medium">New Sale</p>
          <small class="text-muted">{{ sale.product.name }} ({{ sale.quantity_sold }} pcs)</small>
        </div>
      </li>
      {% endfor %}

  
      {% for p in recent_customers %}
      <li class="d-flex align-items-center mb-3">
        <div class="bg-success bg-opacity-10 text-success p-3 rounded-circle d-flex align-items-center justify-content-center">
          <span class="material-symbols-outlined">person_add</span>
        </div>
        <div class="ms-2">
          <p class="mb-0 fw-medium">Recent Customer</p>
          <small class="text-muted">{{ p.name }}</small>
        </div>
      </li>
      {% endfor %}

    
      {% for p in low_stock_products %}
      <li class="d-flex align-items-center mb-3">
        <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-circle d-flex align-items-center justify-content-center">
          <span class="material-symbols-outlined">warning</span>
        </div>
        <div class="ms-2">
          <p class="mb-0 fw-medium">Low Stock</p>
          <small class="text-muted">{{ p.name }} ({{ p.quantity }} pcs)</small>
        </div>
      </li>
      {% endfor %}

    </ul>
  </div>
</div>
  </div>
</div>


{{ sales_data|json_script:"sales-data" }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chartElement = document.getElementById('salesChart');
    const dataElement = document.getElementById('sales-data');
    if (!dataElement || !chartElement) return;

    const salesData = JSON.parse(dataElement.textContent);
    if (!salesData.length) return;

    const labels = salesData.map(item => item.date);
    const data = salesData.map(item => item.total);

    new Chart(chartElement, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Weekly Sales',
          data,
          borderColor: '#1173d4',
          backgroundColor: 'rgba(17,115,212,0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  });
</script>
{% endblock %}
